# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1MopaqWhuW-IBe0pPGG6G-OphdtyXSxG7
"""

import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import plotly.express as px

# åŠ è½½æ•°æ®
# åŠ è½½æ•°æ®
@st.cache
def load_data():
    # ä½¿ç”¨GitHubä¸Šçš„CSVæ–‡ä»¶é“¾æ¥æˆ–æœ¬åœ°æ–‡ä»¶è·¯å¾„
    url = "https://raw.githubusercontent.com/Mhu0824/Streamlit/d6d8457d63867b435bfdea9c541afd71495829f9/movies_dataset.csv"
    return pd.read_csv(url, encoding='ISO-8859-1')

df = load_data()

df['year'] = df['year'].astype(str).str.replace(r'\D', '', regex=True)

# æ ‡é¢˜
st.title("ğŸ¬ Movie Data Dashboard")

# åŠŸèƒ½é€‰æ‹©
option = st.sidebar.radio(
    "Choose a feature:",
    ("Overview", "Genre Distribution", "Top Genres by Country", "Search by Director", "Search by Movie", "Hidden Gems","Compare Movie Rating to Genre Average")
)

# åŠŸèƒ½ 1: æ•°æ®æ¦‚è§ˆ
if option == "Overview":
    st.header("Overview")
    st.write("Dataset Snapshot:")
    st.dataframe(df.head())

# åŠŸèƒ½ 2: ç”µå½±ç±»å‹åˆ†å¸ƒ
elif option == "Genre Distribution":
    st.header("Genre Distribution")

    # å¤„ç†ç”µå½±ç±»å‹æ•°æ®
    genres = pd.concat([
        df['genre_1'].str.strip(), 
        df['genre_2'].str.strip(), 
        df['genre_3'].str.strip(),
        df['genre_4'].str.strip(),
        df['genre_5'].str.strip()
    ]).dropna()

    # è®¡ç®—æ‰€æœ‰ç±»å‹çš„åˆ†å¸ƒ
    genre_counts = genres.value_counts()

    # åœ¨ Streamlit ä¸­æ˜¾ç¤ºæ‰€æœ‰ç±»å‹åŠå…¶æ•°é‡
    st.write("All Genres and Their Counts:")
    st.write(genre_counts)

    # è·å–å‰ 15 ä¸ªç±»å‹åŠå…¶æ•°é‡
    top_15_genres = genre_counts.head(15)

    # å°†å…¶ä½™ç±»å‹åˆå¹¶ä¸º "Other"
    other_count = genre_counts[15:].sum()

    # åˆ›å»ºä¸€ä¸ªæ–°çš„åºåˆ—ï¼Œå°† "Other" ç›´æ¥æ·»åŠ åˆ°å‰ 15 ä¸ªç±»å‹ä¸­
    top_15_genres_with_other = pd.concat(
        [top_15_genres, pd.Series({"Other": other_count})]
    )

    # æ˜¾ç¤ºæŸ±çŠ¶å›¾
    st.header("Top 15 Genres and 'Other'")
    fig, ax = plt.subplots(figsize=(8, 6))
    sns.barplot(x=top_15_genres_with_other.values, y=top_15_genres_with_other.index, ax=ax)
    ax.set_title("Top 15 Genres and 'Other'")
    st.pyplot(fig)

# åŠŸèƒ½ 3: ä¸åŒå›½å®¶ç”µå½±ç±»å‹
elif option == "Top Genres by Country":
    # æ‹†åˆ† country åˆ—
    df['country'] = df['country'].str.split(", ")
    df_exploded = df.explode('country')  # å±•å¼€æˆå¤šè¡Œï¼Œæ¯è¡Œä¸€ä¸ªå›½å®¶

    # åªä½¿ç”¨ genre_1 çš„å†…å®¹
    df_exploded = df_exploded[['country', 'genre_1']].dropna()
    df_exploded['genre_1'] = df_exploded['genre_1'].str.strip()  # å»æ‰ç©ºæ ¼

    # æŒ‰å›½å®¶å’Œ genre_1 ç»Ÿè®¡
    country_genre_counts = df_exploded.groupby(['country', 'genre_1']).size().reset_index(name='count')

    # ç”¨æˆ·é€‰æ‹©å›½å®¶
    countries = country_genre_counts['country'].unique()
    selected_country = st.selectbox("Select a Country:", sorted(countries))

    # è·å–æ‰€é€‰å›½å®¶çš„ Top 10 ç±»å‹
    if selected_country:
        top_genres = country_genre_counts[country_genre_counts['country'] == selected_country]
        top_genres = top_genres.nlargest(10, 'count')

        # é‡å‘½ååˆ—ä¸ºâ€œCountâ€å’Œâ€œGenreâ€
        top_genres_display = top_genres[['genre_1', 'count']].rename(columns={'genre_1': 'Genre', 'count': 'Count'}).reset_index(drop=True)

        # æ˜¾ç¤ºTop 10ç±»å‹åŠå…¶æ•°é‡
        st.write(f"Top 10 Genres for {selected_country}:")
        st.write(top_genres_display)

        # ç»˜åˆ¶æ¡å½¢å›¾
        fig, ax = plt.subplots(figsize=(8, 6))
        sns.barplot(x='Count', y='Genre', data=top_genres_display, ax=ax)
        ax.set_title(f"Top Genres in {selected_country}")
        st.pyplot(fig)

# åŠŸèƒ½ 4: æŒ‰å¯¼æ¼”åå­—æœç´¢
elif option == "Search by Director":
    st.header("Search by Director")

    # ç”¨æˆ·è¾“å…¥å¯¼æ¼”åå­—ï¼Œè‡ªåŠ¨è”æƒ³åŒ¹é…ç»“æœ
    director_name = st.text_input("Enter Director's Name:")
    if director_name:
        matching_directors = sorted(
            {name.strip() for name in df['director'].dropna() if director_name.lower() in name.lower()}
        )
        selected_director = st.selectbox("Select a Director:", matching_directors)
        
        if selected_director:
            # ç­›é€‰å¯¼æ¼”çš„ç”µå½±
            director_movies = df[df['director'].str.contains(selected_director, na=False)]
            
            # æ˜¾ç¤ºå¯¼æ¼”ç”µå½±åŠæ‰€éœ€ä¿¡æ¯
            st.write(f"Movies directed by {selected_director}:")
            st.dataframe(
                director_movies[['title', 'genre_1', 'year', 'imdbRating', 'imdbVotes', 'rating', 'awards']].rename(
                    columns={
                        'title': 'Title', 'genre_1': 'Genre', 'year': 'Year', 
                        'imdbRating': 'IMDB Rating', 'imdbVotes': 'IMDB Votes', 
                        'rating': 'Rating', 'awards': 'Awards'
                    }
                )
            )

            # è®¡ç®—å¯¼æ¼”ç”µå½±å¹³å‡è¯„åˆ†
            avg_rating = director_movies['imdbRating'].mean()
            st.write(f"Average IMDB Rating for {selected_director}'s movies: {avg_rating:.2f}")

# åŠŸèƒ½ 2: æŒ‰ç”µå½±åå­—æœç´¢
elif option == "Search by Movie":
    st.header("Search by Movie")

    # ç”¨æˆ·è¾“å…¥ç”µå½±åå­—ï¼Œè‡ªåŠ¨è”æƒ³åŒ¹é…ç»“æœï¼ˆæ˜¾ç¤ºå¹´ä»½ï¼‰
    movie_name = st.text_input("Enter Movie Title:")

    if movie_name:
        # æ¸…ç†æ•°æ®é›†ä¸­çš„ title å’Œ year åˆ—ï¼Œå»é™¤ç©ºæ ¼å¹¶ç¡®ä¿å¹´ä»½æ˜¯æ•´æ•°
        df['title_clean'] = df['title'].str.strip().str.lower()  # æ¸…ç† title åˆ—
        df['year_clean'] = df['year'].astype(str).str.strip()  # ç¡®ä¿å¹´ä»½æ˜¯å­—ç¬¦ä¸²å¹¶å»é™¤ç©ºæ ¼
        
        # è·å–æ‰€æœ‰ä¸ç”µå½±åç§°åŒ¹é…çš„ç”µå½±ï¼Œå¹¶æ˜¾ç¤ºé™„å¸¦å¹´ä»½çš„ç”µå½±åç§°
        matching_movies = sorted(
            {f"{title.strip()} ({year})" for title, year in zip(df['title_clean'], df['year_clean']) 
             if pd.notna(title) and movie_name.lower() in title.lower()}
        )
        
        # æ˜¾ç¤ºæ‰€æœ‰åŒ¹é…çš„ç”µå½±åç§°ï¼ˆé™„å¸¦å¹´ä»½ï¼‰
        if matching_movies:
            selected_movie_with_year = st.selectbox("Select a Movie:", matching_movies)
            
            if selected_movie_with_year:
                # ä»é€‰é¡¹ä¸­è§£æå‡ºç”µå½±åç§°å’Œå¹´ä»½
                selected_movie, selected_year = selected_movie_with_year.rsplit(" (", 1)
                selected_year = selected_year.rstrip(")")
                
                # æ ¹æ® title_clean å’Œ year_clean ç­›é€‰å”¯ä¸€ç”µå½±
                movie_details = df[(df['title_clean'] == selected_movie.lower()) & (df['year_clean'] == selected_year)]
                
                if not movie_details.empty:
                    # è·å–å¯¼æ¼”åå­—
                    director_name = movie_details['director'].iloc[0]
                    
                    # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    st.write(f"Details for '{selected_movie} ({selected_year})' created by {director_name}:")
                    st.dataframe(
                        movie_details[['title', 'genre_1', 'year', 'imdbRating', 'imdbVotes', 'rating', 'awards']].rename(
                            columns={
                                'title': 'Title', 'genre_1': 'Genre', 'year': 'Year', 
                                'imdbRating': 'IMDB Rating', 'imdbVotes': 'IMDB Votes', 
                                'rating': 'Rating', 'awards': 'Awards'
                            }
                        )
                    )
                    
                    # æ˜¾ç¤ºå¯¼æ¼”å…¶ä»–ä½œå“
                    other_movies = df[df['director'] == director_name]
                    st.write(f"Other movies by {director_name}:")
                    st.dataframe(
                        other_movies[['title', 'genre_1', 'year', 'imdbRating', 'imdbVotes', 'rating', 'awards']].rename(
                            columns={
                                'title': 'Title', 'genre_1': 'Genre', 'year': 'Year', 
                                'imdbRating': 'IMDB Rating', 'imdbVotes': 'IMDB Votes',
                                'rating': 'Rating', 'awards': 'Awards'
                            }
                        )
                    )
                    
                    # è®¡ç®—å¯¼æ¼”å…¶ä»–ç”µå½±çš„å¹³å‡è¯„åˆ†
                    avg_rating = other_movies['imdbRating'].mean()
                    st.write(f"Average IMDB Rating for {director_name}'s movies: {avg_rating:.2f}")
                else:
                    st.write("No movie details found for the selected movie.")
        else:
            st.write("No matching movies found.")
            
# åŠŸèƒ½ 6: å†·é—¨ä½³ä½œ
elif option == "Hidden Gems":
    st.header("Hidden Gems: High Ratings but Low Votes")
    
    # é€‰æ‹©ç±»åˆ«
    st.subheader("Step 1: Select Genre (Optional)")
    genre = st.selectbox(
        "Select a Genre (Leave empty for all genres):", 
        options=["All"] + sorted(df['genre_1'].dropna().unique()),  # åŒ…æ‹¬ "All" é€‰é¡¹
        index=0  # é»˜è®¤é€‰ä¸­ "All"
    )
    
    # è‡ªç”±é€‰æ‹©æŠ•ç¥¨æ•°èŒƒå›´
    st.subheader("Step 2: Select IMDB Votes Range")
    min_votes = st.number_input("Minimum Votes", min_value=0, max_value=2000000, value=0, step=100)
    max_votes = st.number_input("Maximum Votes", min_value=0, max_value=2000000, value=1000, step=100)
    
    # è‡ªç”±é€‰æ‹©è¯„åˆ†èŒƒå›´
    st.subheader("Step 3: Customize Your Rating Range")
    rating_filter = st.slider(
        "Select IMDB Rating Range", 
        min_value=0.0, max_value=10.0, 
        value=(7.0, 10.0),  # åˆå§‹å€¼
        step=0.1  # è¯„åˆ†æ­¥é•¿
    )
    
    # æ•°æ®ç­›é€‰ä¸å±•ç¤º
    filtered_movies = df[
        ((df['genre_1'] == genre) | (genre == "All")) &  # å¦‚æœé€‰æ‹©äº†ç‰¹å®šç±»åˆ«ï¼Œåˆ™ç­›é€‰è¯¥ç±»åˆ«ï¼›å¦åˆ™é€‰æ‹©æ‰€æœ‰ç±»åˆ«
        (df['imdbVotes'] >= min_votes) & 
        (df['imdbVotes'] <= max_votes) & 
        (df['imdbRating'] >= rating_filter[0]) & 
        (df['imdbRating'] <= rating_filter[1])
    ]
    filtered_movies_sorted = filtered_movies.sort_values(by='imdbRating', ascending=False)

    # æ˜¾ç¤ºç­›é€‰ç»“æœ
    st.write(
        f"Movies in {genre if genre != 'All' else 'all genres'} with IMDB Votes between {min_votes} and {max_votes}, "
        f"and IMDB Rating between {rating_filter[0]} and {rating_filter[1]}:"
    )
    st.dataframe(
        filtered_movies_sorted[['title', 'genre_1', 'year', 'imdbRating', 'imdbVotes']].rename(
            columns={
                'title': 'Title', 'genre_1': 'Genre', 'year': 'Year', 
                'imdbRating': 'IMDB Rating', 'imdbVotes': 'IMDB Votes'
            }
        )
    )
    
    # å†·é—¨ä½³ä½œå±•ç¤º
    st.subheader("What This Can Do: Highlighting Hidden Gems")
    hidden_gems = df[
        ((df['genre_1'] == genre) | (genre == "All")) &  # åŒæ ·æ”¯æŒåˆ†ç±»æˆ–å…¨ç±»åˆ«
        (df['imdbVotes'] < 1000) & 
        (df['imdbRating'] > 7.0)
    ]
    hidden_gems_sorted = hidden_gems.sort_values(by='imdbRating', ascending=False)
    
    if not hidden_gems_sorted.empty:
        st.write(
            "For example, here are some *Hidden Gems* (highly rated movies(>7.0) with less than 1000 votes):"
        )
        st.dataframe(
            hidden_gems_sorted[['title', 'genre_1', 'year', 'imdbRating', 'imdbVotes']].rename(
                columns={
                    'title': 'Title', 'genre_1': 'Genre', 'year': 'Year', 
                    'imdbRating': 'IMDB Rating', 'imdbVotes': 'IMDB Votes'
                }
            )
        )
    else:
        st.write(f"No hidden gems found in {genre if genre != 'All' else 'all genres'}.")

# æ–°åŠŸèƒ½: ç”µå½±è¯„åˆ†ä¸ç±»åˆ«å‡åˆ†æ¯”è¾ƒ
elif option == "Compare Movie Rating to Genre Average":
    st.header("Compare Movie Rating to Genre Average")

    # ç”¨æˆ·è¾“å…¥ç”µå½±åå­—
    movie_name = st.text_input("Enter Movie Title:")

    if movie_name:
        # ç¡®ä¿åˆ—å·²å­˜åœ¨å¹¶è¿›è¡Œæ•°æ®æ¸…ç†
        if 'title_clean' not in df.columns:
            df['title_clean'] = df['title'].str.strip().str.lower()  # æ¸…ç† title åˆ—
        if 'year_clean' not in df.columns:
            df['year_clean'] = df['year'].astype(str).str.strip()  # ç¡®ä¿å¹´ä»½æ˜¯å­—ç¬¦ä¸²å¹¶å»é™¤ç©ºæ ¼

        # è·å–åŒ¹é…çš„ç”µå½±ï¼Œå¹¶æ˜¾ç¤ºé™„å¸¦å¹´ä»½çš„ç”µå½±åç§°
        matching_movies = sorted(
            {f"{title} ({year})" for title, year in zip(df['title'], df['year']) 
             if pd.notna(title) and movie_name.lower() in title.lower()}
        )

        if matching_movies:
            # ç”¨æˆ·é€‰æ‹©ç”µå½±
            selected_movie_with_year = st.selectbox("Select a Movie:", matching_movies)

            if selected_movie_with_year:
                # ä»é€‰é¡¹ä¸­è§£æç”µå½±åç§°å’Œå¹´ä»½
                selected_movie, selected_year = selected_movie_with_year.rsplit(" (", 1)
                selected_year = selected_year.rstrip(")")

                # æ ¹æ®æ ‡é¢˜å’Œå¹´ä»½ç­›é€‰ç”µå½±
                movie_details = df[
                    (df['title_clean'] == selected_movie.strip().lower()) &
                    (df['year_clean'] == selected_year)
                ]
                    if not movie_details.empty:
                        st.write(f"Selected Movie: **{selected_movie} ({selected_year})**")
                        st.write(movie_details)
                    
                        # è·å–æ‰€é€‰ç”µå½±çš„ç±»å‹
                        genres = movie_details.iloc[0][['genre_1', 'genre_2', 'genre_3', 'genre_4', 'genre_5']].dropna().tolist()
                    
                        # éå†ç±»å‹ï¼Œè®¡ç®—æ¯ç§ç±»å‹çš„å‡åˆ†å¹¶ä¸è¯¥ç”µå½±çš„è¯„åˆ†å¯¹æ¯”
                        comparisons = []
                        for genre in genres:
                            genre_movies = df[
                                (df['genre_1'] == genre) | 
                                (df['genre_2'] == genre) | 
                                (df['genre_3'] == genre) | 
                                (df['genre_4'] == genre) | 
                                (df['genre_5'] == genre)
                            ].dropna(subset=['imdbRating'])
                    
                            if not genre_movies.empty:
                                genre_avg_rating = genre_movies['imdbRating'].mean()
                                movie_rating = movie_details['imdbRating'].iloc[0]
                                comparisons.append({
                                    'Genre': genre,
                                    'Movie Rating': movie_rating,
                                    'Genre Avg Rating': genre_avg_rating,
                                    'Difference': movie_rating - genre_avg_rating  # è®¡ç®—å·®å¼‚
                                })
                            else:
                                comparisons.append({
                                    'Genre': genre,
                                    'Movie Rating': movie_details['imdbRating'].iloc[0],
                                    'Genre Avg Rating': None,
                                    'Difference': None
                                })
                    
                        comparison_df = pd.DataFrame(comparisons)
                    
                        # ç»˜åˆ¶æ›´ç›´è§‚çš„å›¾è¡¨
                        try:
                            fig = px.bar(
                                comparison_df,
                                x='Genre',
                                y='Difference',
                                color='Difference',
                                text='Difference',
                                color_continuous_scale=['red', 'green'],  # è´Ÿå€¼ä¸ºçº¢ï¼Œæ­£å€¼ä¸ºç»¿
                                labels={'Difference': 'Rating Difference (Movie - Avg)'},
                                title=f"Rating Difference: {selected_movie} vs Genre Averages"
                            )
                            fig.update_traces(texttemplate='%{text:.2f}', textposition='outside')  # æ˜¾ç¤ºå·®å€¼
                            fig.update_layout(
                                xaxis_title="Genre",
                                yaxis_title="Rating Difference",
                                showlegend=False,
                                coloraxis_showscale=False
                            )
                            st.plotly_chart(fig)
                    
                        except Exception as e:
                            st.error(f"Error creating chart: {e}")
                    else:
                        st.error("No matching movie found with the given title and year.")
