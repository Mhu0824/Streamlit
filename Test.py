# -*- coding: utf-8 -*-
"""Untitled0.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1MopaqWhuW-IBe0pPGG6G-OphdtyXSxG7
"""

import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns

# 加载数据
@st.cache
def load_data():
    # 使用GitHub上的CSV文件链接或本地文件路径
    url = "https://raw.githubusercontent.com/Mhu0824/Streamlit/7597d71c7c5646ee30b516460841ebb7defbcdc8/movies_dataset.csv"
    return pd.read_csv(url, encoding='ISO-8859-1')

# 数据加载
df = load_data()

# 标题
st.title("🎬 Movie Data Dashboard")

# 功能选择
option = st.sidebar.radio(
    "Choose a feature:",
    ("Overview", "Genre Distribution", "Top Genres by Country", "Search by Director", "Search by Movie")
)

# 功能 1: 数据概览
if option == "Overview":
    st.header("Overview")
    st.write("Dataset Snapshot:")
    st.dataframe(df.head())

# 功能 2: 电影类型分布
elif option == "Genre Distribution":
    st.header("Genre Distribution")

    # 处理电影类型数据
    genres = pd.concat([
        df['genre_1'].str.strip(), 
        df['genre_2'].str.strip(), 
        df['genre_3'].str.strip(),
        df['genre_4'].str.strip(),
        df['genre_5'].str.strip()
    ]).dropna()

    # 计算所有类型的分布
    genre_counts = genres.value_counts()

    # 在 Streamlit 中显示所有类型及其数量
    st.write("All Genres and Their Counts:")
    st.write(genre_counts)

    # 获取前 15 个类型及其数量
    top_15_genres = genre_counts.head(15)

    # 将其余类型合并为 "Other"
    other_count = genre_counts[15:].sum()

    # 创建一个新的序列，将 "Other" 直接添加到前 15 个类型中
    top_15_genres_with_other = pd.concat(
        [top_15_genres, pd.Series({"Other": other_count})]
    )

    # 显示柱状图
    st.header("Top 15 Genres and 'Other'")
    fig, ax = plt.subplots(figsize=(8, 6))
    sns.barplot(x=top_15_genres_with_other.values, y=top_15_genres_with_other.index, ax=ax)
    ax.set_title("Top 15 Genres and 'Other'")
    st.pyplot(fig)

# 功能 3: 不同国家电影类型
elif option == "Top Genres by Country":
    # 拆分 `country` 列
    df['country'] = df['country'].str.split(", ")
    df_exploded = df.explode('country')  # 展开成多行，每行一个国家

    # 只使用 `genre_1` 的内容
    df_exploded = df_exploded[['country', 'genre_1']].dropna()
    df_exploded['genre_1'] = df_exploded['genre_1'].str.strip()  # 去掉空格

    # 按国家和 `genre_1` 统计
    country_genre_counts = df_exploded.groupby(['country', 'genre_1']).size().reset_index(name='count')

    # 用户选择国家
    countries = country_genre_counts['country'].unique()
    selected_country = st.selectbox("Select a Country:", sorted(countries))

    # 获取所选国家的 Top 10 类型
    if selected_country:
        top_genres = country_genre_counts[country_genre_counts['country'] == selected_country]
        top_genres = top_genres.nlargest(10, 'count')

        # 重命名列为“Count”和“Genre”
        top_genres_display = top_genres[['genre_1', 'count']].rename(columns={'genre_1': 'Genre', 'count': 'Count'}).reset_index(drop=True)

        # 显示Top 10类型及其数量
        st.write(f"Top 10 Genres for {selected_country}:")
        st.write(top_genres_display)

        # 绘制条形图
        fig, ax = plt.subplots(figsize=(8, 6))
        sns.barplot(x='Count', y='Genre', data=top_genres_display, ax=ax)
        ax.set_title(f"Top Genres in {selected_country}")
        st.pyplot(fig)

# 功能 4: 按导演名字搜索
elif option == "Search by Director":
    st.header("Search by Director")

    director_name = st.text_input("Enter Director's Name:")
    if director_name:
        matching_directors = df['director'].dropna().unique()
        matching_directors = [name for name in matching_directors if director_name.lower() in name.lower()]
        if matching_directors:
            selected_director = st.selectbox("Select a Director:", matching_directors)
            if selected_director:
                director_movies = df[df['director'] == selected_director]
                st.write(f"Movies directed by {selected_director}:")
                st.dataframe(director_movies[['title', 'year', 'imdbRating', 'imdbVotes', 'rating', 'awards']].rename(
                    columns={
                        'title': 'Title', 'year': 'Year', 'imdbRating': 'IMDB Rating',
                        'imdbVotes': 'IMDB Votes', 'rating': 'Rating', 'awards': 'Awards'
                    }
                ))

                avg_rating = director_movies['imdbRating'].mean()
                st.write(f"Average IMDB Rating for {selected_director}'s movies: {avg_rating:.2f}")
        else:
            st.write(f"No directors found matching: {director_name}")

# 功能 5: 按电影名字搜索
elif option == "Search by Movie":
    st.header("Search by Movie")

    movie_name = st.text_input("Enter Movie Title:")
    if movie_name:
        matching_movies = df['title'].dropna().unique()
        matching_movies = [title for title in matching_movies if movie_name.lower() in title.lower()]
        if matching_movies:
            selected_movie = st.selectbox("Select a Movie:", matching_movies)
            if selected_movie:
                movie_details = df[df['title'] == selected_movie]
                st.write(f"Details for '{selected_movie}':")
                st.dataframe(movie_details[['title', 'director', 'year', 'imdbRating', 'imdbVotes', 'rating', 'awards']].rename(
                    columns={
                        'title': 'Title', 'director': 'Director', 'year': 'Year',
                        'imdbRating': 'IMDB Rating', 'imdbVotes': 'IMDB Votes', 'rating': 'Rating', 'awards': 'Awards'
                    }
                ))

                movie_director = movie_details['director'].iloc[0]
                other_movies = df[df['director'] == movie_director]
                st.write(f"Other movies by {movie_director}:")
                st.dataframe(other_movies[['title', 'year', 'imdbRating', 'imdbVotes']].rename(
                    columns={'title': 'Title', 'year': 'Year', 'imdbRating': 'IMDB Rating', 'imdbVotes': 'IMDB Votes'}
                ))

                avg_rating = other_movies['imdbRating'].mean()
                st.write(f"Average IMDB Rating for {movie_director}'s movies: {avg_rating:.2f}")
        else:
            st.write(f"No movies found matching: {movie_name}")
        else:
            st.write(f"No movies found matching: {movie_name}")
